<!-- calandar.html (полная версия) -->
<script>
    const master = new URLSearchParams(window.location.search).get('master');
    let currentDate = new Date();

    async function loadSlots(date) {
        try {
            const response = await fetch(`/api/slots/${master}`);
            const slots = await response.json();
            return slots[date] || [];
        } catch (error) {
            console.error('Ошибка загрузки:', error);
            return [];
        }
    }

    async function generateCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        // ... ваш код отрисовки календаря ...

        for (let day = 1; day <= lastDay.getDate(); day++) {
            const date = new Date(year, month, day);
            const dateString = date.toISOString().split('T')[0];
            const slots = await loadSlots(dateString);

            const dayElement = document.createElement('div');
            dayElement.classList.add('calendar-day');
            dayElement.textContent = day;

            if (slots.length > 0) {
                dayElement.classList.add('available');
                dayElement.addEventListener('click', () => showTimeSlots(dateString));
            } else {
                dayElement.classList.add('unavailable');
            }

            calendar.appendChild(dayElement);
        }
    }

    async function showTimeSlots(date) {
        const slots = await loadSlots(date);
        timeSlots.innerHTML = slots.map(time => `
            <div class="time-slot available"
                 data-date="${date}"
                 data-time="${time}"
                 onclick="handleBooking('${date}', '${time}')">
                ${time}
            </div>
        `).join('');
    }

    async function handleBooking(date, time) {
        const service = prompt('Введите название услуги:');
        if (!service) return;

        try {
            const response = await fetch('/book', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    master: master,
                    date: date,
                    time: time,
                    service: service
                })
            });

            if (response.ok) {
                document.querySelectorAll(`[data-date="${date}"][data-time="${time}"]`)
                    .forEach(el => el.classList.replace('available', 'unavailable'));
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }

    // Инициализация
    generateCalendar();
</script>